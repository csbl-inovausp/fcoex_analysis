# FCOEX - FCBF-based CoExpression 

To start, we will download and clean our datasets of interest.



1 dataset from 10x Genomics downloaded via the data package seurat-data (https://github.com/satijalab/seurat-data)
 
```{r Downloading the data. , eval = FALSE }
# devtools::install_github('satijalab/seurat-data')
library('SeuratData')
options(timeout=1000)
InstallData("pbmc3k")
```


For starters, we will load the pbmc3k dataset from the SeuratData. This simulates the output of a common Seurat clustering pipeline.   

```{r Loading data}
library(Seurat)
library(SeuratData)

data("pbmc3k.final")
```

```{r Print object from SeuratData}
print(pbmc3k.final)
DimPlot(pbmc3k.final)
```


Now that we have our base Seurat object we can perform the fcoex analysis. Let's time it too. 


```{r Creating the fcoex object}

library(fcoex)

ptm <- proc.time()

exprs <- as.data.frame(GetAssayData(object = pbmc3k.final, slot = "data"))
target <- Idents(pbmc3k.final)


fc <- new_fcoex(data.frame(exprs),target)
fc <- discretize(fc)

fc <- find_cbf_modules(fc)
fc <- recluster(fc)


time_taken = proc.time() - ptm
```
```{r Print the time taken}
time_taken
```

In my laptop, it takes 2-5 minutes to complete the run. Let's do some plotting.

Of note, the current memory handling of the fcoex package is not very good: it takes around 8x the amount of memory of the Seurat object that it processes. For the pbmc3k dataset that is not a problem, but it make it necessary to usea server with more RAM for larger datasets.

Let's save the fc object for the future:

```{r Print the time taken}
library(readr)
write_rds(
  x=fc,
  file="../data/intermediate_data/fc_pbmc3k.rds",
  compress = c("gz"))

```

The "save_plots" function saves the co-expression modules to a PDF file. 
The "show net" 

```{r Plotting the basic plots}

save_plots(name = "pbmc3k", fc, force = T, directory = "results/intermediate")
library(patchwork)
library(ggplot2)

coex_module_plots <- show_net(fc)

p_module_1 <- coex_module_plots[["HLA-DRB1"]] + theme(legend.position="none")


p_module_2 <- coex_module_plots[["PTPRCAP"]] + theme(legend.position="none")

p_module_1 + p_module_2
```

Let's try and plot the modules in a different way. 


```{r}
library(patchwork)

modules_to_filter <-module_genes(fc)

heat_1 <- DoHeatmap(object = pbmc3k.final, 
          slot = "data",
          size = 5,
          raster = FALSE,
          features = c(modules_to_filter[["HLA-DRB1"]])) +
      scale_fill_gradient(low = "white", high = "black")  +
      theme(legend.position = "none",
            axis.line.y = element_line()) +
      ylab("M5 (HLA-DRB1)")


heat_2 <- DoHeatmap(object = pbmc3k.final, 
          label = FALSE,
          slot = "data",
          size = 5,
          raster = FALSE,
          features = c(modules_to_filter[["CD3D"]])) +
      scale_fill_gradient(low = "white", high = "black")  +
      theme(legend.position = "none",
            axis.line.y = element_line()) +
      ylab("M2 (CD3D)")


heat_3 <- DoHeatmap(object = pbmc3k.final, 
          label = FALSE,
          slot = "data",
          size = 5,
          raster = FALSE,
          features = c(modules_to_filter[["CST7"]])) +
      scale_fill_gradient(low = "white", high = "black")  +
      theme(legend.position = "none",
            axis.line.y = element_line()) +
      ylab("M8 (CST7)")

p_heat <- (heat_1 / heat_2 / heat_3)
p_heat
```

Now that we have the modules, we would like to look at the reclusterings.

For that, we will re-integrate the fcoex outputs with the Seurat object.


```{r Plotting the reclusterings}
library(Seurat)
library(ggplot2)
library(dplyr)

# source("../fcoex_themes.R")

module_idents <- data.frame(fc@mod_idents)

colnames(module_idents) <- paste("fcoex", colnames(module_idents), sep="_")

metadata = cbind(pbmc3k.final@meta.data, module_idents)

pbmc3k.final@meta.data <- metadata

print(head(pbmc3k.final@meta.data))
```

Now the modules are inside the metadata of the Seurat object. 

```{r}

recluster_theme <- function(){
  theme(#axis.title=element_blank(),
        #axis.line =element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank(),
        legend.position = "none",
        legend.direction = "vertical",
        plot.title = element_text(hjust = 0.5, face = "plain", size = 20))
}

p1 <- DimPlot(pbmc3k.final) +
    theme(# axis.title=element_blank(),
        # axis.line =element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank(),
        plot.title = element_text(hjust = 0.5, face = "plain", size = 25))+
  ggtitle("pbmc3k")
p2 <- DimPlot(pbmc3k.final, group.by = "fcoex_HLA.DRB1", cols = c("gray70", "black")) + 
  recluster_theme() +
  ggtitle("C5 (HLA-DRB1)")
p3 <- DimPlot(pbmc3k.final, group.by = "fcoex_CD3D", cols = c("gray70", "black")) +
  recluster_theme() +
  ggtitle("C2 (CD3D)")
p4 <- DimPlot(pbmc3k.final, group.by = "fcoex_CST7", cols = c("gray70", "black")) +
  recluster_theme() +
  ggtitle("C8 (CST7)")

layout <- "
AABBBCCDDEE
AABBBCCDDEE
"

ggsave("../results/figures/fcoex_pipeline_pbmc3k.pdf", width = 20, height = 7)
p1 + p_heat + p2 + p3 +p4 + plot_layout(design = layout) 
dev.off()
p1 + p_heat + p2 + p3 +p4 + plot_layout(design = layout) 

```

So we see that module one divides the dataset into myeloid (DC + Monocytes) and non-myeloid cells. Cool!

Let's look at a heatmap and look in a different way how the coexpression clusters relate to the original labels.


```{r Plotting the percentage heatmap}
library(tidyr)
library(scales)

original_clusters <- data.frame(table(Idents(pbmc3k.final)))

metadata <- pbmc3k.final@meta.data

seurat_to_fcoex_proportions = list()
for (identity in levels(Idents(pbmc3k.final))){
  
  identity_metadata = metadata[metadata["seurat_annotations"] == identity,]
  
  proportions_for_this_identity = list()

  for (col_name in colnames(identity_metadata)){
    if (grepl("fcoex", col_name)){
      
      total_cells = nrow(identity_metadata)
      header_positive_cells = sum(identity_metadata[col_name] == "HP")
      proportions_for_this_identity[[col_name]] <- header_positive_cells/total_cells 
    }
  seurat_to_fcoex_proportions[[identity]] <- proportions_for_this_identity
}
}

proportions_df <- data.frame(do.call(rbind, seurat_to_fcoex_proportions))
```

Now let's plot it. First I'll write a function to prepare the dataframe in the ggplot2 format.


```{r}
library(tidyr)
library(tibble)

prepare_proportions_df <-function(proportion_df){
  # Cluster to get factor order ----------
  seurat_distances <- dist(proportions_df)
  fcoex_distances <- dist(t(proportions_df))
  seurat_clustering <- hclust(seurat_distances)
  fcoex_clustering <- hclust(fcoex_distances)

  # Pivot to longer format -----------
  proportions_df$Seurat <- rownames(proportions_df)
  proportions_df_long <- proportions_df %>%
    pivot_longer(cols = !Seurat,names_to="fcoex", values_to="proportion") 

  # Adjust types and order of levels of columns in dataframe ----------
  proportions_df_long$proportion <- as.numeric(proportions_df_long$proportion)
  
  proportions_df_long$Seurat <- factor(proportions_df_long$Seurat, levels = seurat_clustering$labels[seurat_clustering$order])
  
  proportions_df_long$fcoex <- factor(proportions_df_long$fcoex, levels = fcoex_clustering$labels[fcoex_clustering$order])
  
  proportions_df_long
}

```


Now plotting it.

```{r}
ggsave("../results/figures/fcoex_reclusterings_pbmc3k.pdf", width = 4, height= 4)
proportions_df %>%
  prepare_proportions_df() %>%
  ggplot(aes_string(x="Seurat", y="fcoex", fill="proportion")) +
    geom_tile() +
    scale_fill_gradient(low = "white", high = "purple3") +
    theme_bw()+
    theme(axis.text.x = element_text(angle = 70, hjust = 1))
dev.off()
```


Checking DEGs for some fcoex clusters

```{r}
markers_m5 <- FindMarkers(pbmc3k.final,
                          ident.1 = "HP",
                          group.by = "fcoex_HLA.DRB1",
                          only.pos = TRUE) %>%
              tibble::rownames_to_column(var = "gene")

markers_m2 <- FindMarkers(pbmc3k.final,
                      ident.1 = "HP",
                      group.by = "fcoex_CD3D",
                          only.pos = TRUE)  %>% 
              tibble::rownames_to_column(var = "gene")

markers_m7 <- FindMarkers(pbmc3k.final,
                      ident.1 = "HP",
                      group.by = "fcoex_CST7",
                          only.pos = TRUE) %>% 
              tibble::rownames_to_column(var = "gene")

markers_m9 <- FindMarkers(pbmc3k.final,
                      ident.1 = "HP",
                      group.by = "fcoex_FCGR3A",
                      only.pos = TRUE) %>% 
                tibble::rownames_to_column(var = "gene")

library("readr")
write_tsv(markers_m5,
          file = "results/markers_hla.tsv" )

write_tsv(markers_m2,
          file = "results/markers_cd3d.tsv" )

write_tsv(markers_m7,
          file = "results/markers_cst7.tsv" )

write_tsv(markers_m9,
          file = "results/markers_fcgr3a.tsv" )


FeaturePlot(pbmc3k.final, features=rownames(head(markers_m9, 6)))




```

